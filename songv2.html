<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title id="titleMessage">木子才演唱会</title>
    <style>
        /* 保持原有样式不变 */
        body {
            padding: 0;
            margin: 0;
            display: flex;
            height: 100vh;
            flex-direction: column;
            justify-content: center;
            align-items: center;

            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation; /* 防止双击缩放 */
        }
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        button {
            padding: 8px 8px;
            cursor: pointer;
            margin: 0 5px; /* 增加一点按钮间距 */
        }
        .bgColor {
            background-color: #fcfcfc;
        }
        .textColor {
            color: #333333;
            text-align: center;
        }
        .buttonContentLoad {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        .buttonContent {
            top: 0;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }
        .div1 {
            height: auto;
            margin: 20px 0;
        }
        .div2 {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            height: auto;
            flex-wrap: wrap; /* 允许按钮换行 */
            gap: 5px;
            padding: 10px;
        }
        .songInfo {
            margin-bottom: 10px;
            padding: 0;
            margin: 0;
            margin-top: 8px;
        }
    </style>
</head>
<body onclick="bodyAction()" class="bgColor">
    <div class="container">
        <p id="songInfo"  class="textColor songInfo" >木子才演唱会</p>

        <div class="div1">
            <h3 id="title"  class="textColor" ></h3>
            <audio id="player" onended="handleEnded()" controls>
                Your browser does not support the audio element.
            </audio>
        </div>

        <div class="div2">
            <button class="textColor" onclick="handlePreviousTrack()">上一首</button>
            <button class="textColor" id="playOrPauseButton">播放</button>
            <button class="textColor" onclick="handleNextTrack()">下一首</button>
            <button class="textColor" id="loopButton" onclick="handleLoop()">模式全部</button>
            <button class="textColor" onclick="playRandomTrack()">抽歌</button>
            <button class="textColor" id="listButton" onclick="listShowOrHidden()">列表隐藏</button>
            <!-- 添加数据源切换按钮 -->
            <button class="textColor" id="sourceSwitchButton" onclick="switchDataSource()">切换到2025年演唱会</button>
        </div>
        <div class="buttonContentLoad" id="songList" style="display: none;">
            <div class="buttonContent" id="buttonContent"></div>
        </div>
    </div>

    <!-- 引入两个数据源 -->
    <script src="https://yococoxc.github.io/tool/data/sunodata2.js"></script>
    <script src="https://yococoxc.github.io/tool/data/sunodata2025.js"></script>
    <script type="text/javascript">
        // 定义当前使用的数据源，默认使用原始数据源
        let currentTracks = tracks;
        let isUsing2025 = false; // 标记当前是否使用2025数据源

        var loopValue = 0;
        var isFrist = true;
        var isPlaying = false;
        
        var player = document.getElementById('player');
        var currentTitle = null;
        var currentIndex = 0;
        var currentUrl = null;

        // 处理循环模式切换
        function handleLoop() {
            loopValue++;
            if (loopValue >= 4) {
                loopValue = 0;
            }

            if (loopValue == 0) {
                document.getElementById('loopButton').innerHTML = '模式全部';
            } else if (loopValue == 1) {
                document.getElementById('loopButton').innerHTML = '模式歌组';
            } else if (loopValue == 2) {
                document.getElementById('loopButton').innerHTML = '模式单曲';
            } else if (loopValue == 3) {
                document.getElementById('loopButton').innerHTML = '模式随机';
            }
        }

        // 显示/隐藏列表
        function listShowOrHidden() {
            var list = document.getElementById('songList');
            if (list.style.display == 'none') {
                list.style.display = 'flex';
                document.getElementById('listButton').innerHTML = '列表隐藏';
            } else {
                list.style.display = 'none';
                document.getElementById('listButton').innerHTML = '列表显示';
            }
        }

        // 歌曲组按钮点击事件
        function trackButtonAction(e) {
            let index = e.target.getAttribute('data-index');
            let array = currentTracks[index].array; // 使用当前数据源
            if (array.length == 0) {
                e.stopPropagation();
                return;
            }

            currentIndex = index;
            playNextTrack();
            e.stopPropagation();
        }

        // 播放器事件监听
        player.addEventListener('play', function () {
            isPlaying = true;
            document.getElementById('playOrPauseButton').innerHTML = '暂停';
        });

        player.addEventListener('pause', function () {
            isPlaying = false;
            document.getElementById('playOrPauseButton').innerHTML = '播放';
        });

        // 初始化歌曲列表
        function initSongList() {
            var buttonContent = document.getElementById('buttonContent');
            // 清空现有列表
            buttonContent.innerHTML = '';
            let sumTrackNum = 0;
            
            for (var i = 0; i < currentTracks.length; i++) { // 使用当前数据源
                let tempTrack = currentTracks[i];

                var button = document.createElement('button');
                button.innerHTML = i + 1 + '. ' + tempTrack.title + ' (' +  tempTrack.array.length + ')';
                button.className = "textColor";
                button.setAttribute('data-index', i);
                button.onclick = trackButtonAction;
                buttonContent.appendChild(button);

                sumTrackNum += tempTrack.array.length;
            }

            // 滚动到顶部
            requestAnimationFrame(() => {
                buttonContent.scrollTop = 0;
            });

            // 更新歌曲总数信息
            document.getElementById('songInfo').innerHTML = `木子才${isUsing2025 ? '2025年演唱会' : '全部歌曲'}，共 ${sumTrackNum} 首`;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initSongList();
        });

        // 随机播放
        function playRandomTrack() {
            currentIndex = Math.floor(Math.random() * currentTracks.length); // 使用当前数据源
            let array = currentTracks[currentIndex].array;
            if (array.length == 0) {
                playRandomTrack();
                return;
            }

            playNextTrack();
        }

        // 播放下一首
        function playNextTrack() {
            if (isFrist) {
                document.getElementById('playOrPauseButton').innerHTML = '播放';
            } else {
                document.getElementById('playOrPauseButton').innerHTML = '暂停';
            }
            
            isFrist = false;

            let array = currentTracks[currentIndex].array; // 使用当前数据源
            if (array == undefined || array.length == 0) {
                return;
            }

            var newIndex = Math.floor(Math.random() * array.length);
            let tempTrack = array[newIndex];

            currentTitle = tempTrack.name2;
            currentUrl = tempTrack.mp3;

            player.src = currentUrl;
            player.play();
            isPlaying = true;


            document.getElementById('titleMessage').innerHTML = `木子才${isUsing2025 ? '2025年演唱会' : '全部歌曲'} 《${currentTitle}》`;
            document.getElementById('title').innerHTML = currentTitle;
        }

        // 上一首
        function handlePreviousTrack() {
            if (loopValue == 3) {
                playRandomTrack();
                return;
            }
            currentIndex = parseInt(currentIndex) - 1;
            if (currentIndex < 0) {
                currentIndex = currentTracks.length - 1; // 使用当前数据源
            }

            let array = currentTracks[currentIndex].array; // 使用当前数据源
            if (array.length == 0) {
                handlePreviousTrack();
                return;
            }

            playNextTrack();
        }
        
        // 下一首
        function handleNextTrack() {
            if (loopValue == 3) {
                playRandomTrack();
                return;
            }
            currentIndex = parseInt(currentIndex) + 1;
            if (currentIndex >= currentTracks.length) { // 使用当前数据源
                currentIndex = 0;
            }

            let array = currentTracks[currentIndex].array; // 使用当前数据源
            if (array.length == 0) {
                handleNextTrack();
                return;
            }

            playNextTrack();
        }
        
        // 播放结束处理
        function handleEnded() {
            if (loopValue == 3) {
                playRandomTrack();
                return;
            }
            if (loopValue == 1) {
                playNextTrack();
                return;
            }
            if (loopValue == 2) {
                player.src = currentUrl;
                player.play();
                isPlaying = true;
                return;
            }

            currentIndex = parseInt(currentIndex) + 1;
            if (currentIndex >= currentTracks.length) { // 使用当前数据源
                currentIndex = 0;
            }

            let array = currentTracks[currentIndex].array; // 使用当前数据源
            if (array.length == 0) {
                handleEnded();
                return;
            }

            playNextTrack();
        }

        // 播放/暂停按钮
        document.getElementById('playOrPauseButton').addEventListener('click', function() {
            isFrist = false;

            if (isPlaying) {
                player.pause();
                isPlaying = false;
                document.getElementById('playOrPauseButton').innerHTML = '播放';
            } else {
                if (!player.src || player.ended) {
                    playNextTrack();
                } else {
                    player.play();
                    isPlaying = true;
                }
                document.getElementById('playOrPauseButton').innerHTML = '暂停';
            }
        });

        // 页面加载完成后自动播放
        window.onload = function() {
            playNextTrack();
            isFrist = true;
        }
        
        //  body点击事件
        function bodyAction() {
            if (isFrist == false) {
                return;
            }
            isFrist = false;

            player.play();
            isPlaying = true;
            document.getElementById('playOrPauseButton').innerHTML = '暂停';
        }

        // 切换数据源函数
        function switchDataSource() {
            // 切换数据源标记
            isUsing2025 = !isUsing2025;
            // 更新当前数据源
            currentTracks = isUsing2025 ? tracks2025 : tracks;
            // 更新切换按钮文字
            document.getElementById('sourceSwitchButton').innerHTML = isUsing2025 ? '切换到全部歌曲' : '切换到2025年演唱会';
            // 重置当前播放索引
            currentIndex = 0;
            // 重新初始化歌曲列表
            initSongList();
            // 停止当前播放并加载新数据源的歌曲
            player.pause();
            playNextTrack();
        }
    </script>
</body>
</html>
